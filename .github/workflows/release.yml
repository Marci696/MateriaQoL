name: Release (master)

on:
    push:
        branches: [ master ]
        paths-ignore:
            - repo.json

permissions:
    contents: write

jobs:
    release:
        runs-on: windows-2022
        
        steps:
            -   name: Checkout
                uses: actions/checkout@v5
                with:
                    submodules: recursive

            -   name: Install .NET
                uses: actions/setup-dotnet@v5
                with:
                    dotnet-version: 10.0.x

            -   name: Download Dalamud
                shell: pwsh
                run: |
                    Invoke-WebRequest -Uri https://goatcorp.github.io/dalamud-distrib/latest.zip -OutFile latest.zip
                    Expand-Archive -Force latest.zip "$env:AppData\XIVLauncher\addon\Hooks\dev"

            -   name: Compute Version
                id: ver
                shell: pwsh
                run: |
                    $ver = "0.1.${{ github.run_number }}.0"
                    "version=$ver" >> $env:GITHUB_OUTPUT
                    Write-Host "Version: $ver"

            -   name: Build (Release)
                shell: pwsh
                run: |
                    dotnet build --configuration Release `
                      /p:Version=${{ steps.ver.outputs.version }} `
                      /p:AssemblyVersion=${{ steps.ver.outputs.version }} `
                      /p:FileVersion=${{ steps.ver.outputs.version }}

            -   name: Package zip
                shell: pwsh
                run: |
                    $src = "MateriaQoL\bin\x64\Release\MateriaQoL\*"
                    if (Test-Path "MateriaQoL.zip") { Remove-Item "MateriaQoL.zip" -Force }
                    Compress-Archive -Path $src -DestinationPath "MateriaQoL.zip" -Force

            -   name: Update repo.json AssemblyVersion + links
                shell: pwsh
                run: |
                    $path = "repo.json"
                    $json = Get-Content $path -Raw | ConvertFrom-Json
                    
                    $json[0].AssemblyVersion = "${{ steps.ver.outputs.version }}"
                    $json[0].DownloadLinkInstall = "https://github.com/${{ github.repository }}/releases/download/latest/MateriaQoL.zip"
                    $json[0].DownloadLinkUpdate  = "https://github.com/${{ github.repository }}/releases/download/latest/MateriaQoL.zip"
                    
                    $json | ConvertTo-Json -Depth 32 | Set-Content -Path $path -Encoding UTF8

            -   name: Commit repo.json
                shell: pwsh
                run: |
                    git config user.name "github-actions[bot]"
                    git config user.email "github-actions[bot]@users.noreply.github.com"
                    git add repo.json
                    git commit -m "Update repo.json for ${{ steps.ver.outputs.version }} [skip ci]" || exit 0
                    git push

            -   name: "Publish/Update GitHub Release (tag: latest)"
                uses: softprops/action-gh-release@v2
                with:
                    tag_name: latest
                    name: Latest (master)
                    prerelease: true
                    files: MateriaQoL.zip
